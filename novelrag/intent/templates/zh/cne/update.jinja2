{% import "zh/cne/_macros.jinja2" as macros %}

{{ macros.language_instruction() }}

---核心叙事元素定义（Definition）---
> **核心叙事元素**是构建故事大纲的“最小叙事单元”，
> 用于聚焦并呈现一个独立的叙事侧面或维度，确保大纲层次清晰、视角多元。
> 每个元素应满足：
> 1. **单一聚焦**：只关注一个或一组高度相关的叙事主题，比如角色成长、冲突发展、社会结构、文化意象等。
> 2. **独立性**：具备独立名称（`name`）和功能描述（`description`），能单独被理解并可复用。
> 3. **领域标注**：通过`domains`字段指明所属叙事领域，便于后续自动化验证“领域不重叠”。
> 4. **补全大纲**：每个元素须针对大纲中尚未覆盖的侧面提出新的视角，使整体框架更丰满。
> 5. **可扩展 metadata**：可根据需要添加若干可选字段，如`themes`、`symbolism`、`historical_context`、`psychological_conflict`等，以提供更丰富的叙事线索。

---更新核心叙事元素（Update Core Element）---
> 本流程用于“在已有核心叙事元素基础上修改或补充字段”，
> 最终输出一个新的 JSON 字典，将对指定元素的原始字段进行**覆盖式更新**。

---会话上下文---
- **当前会话内容汇总**：{{ session_summary }}
- **相关的其他元素**：{{ related_info }}

---目标元素（Target Element）---

```json
{{ target_cne }}
```

{% if user_update_input %}
---用户更新指令（User Update Instructions）---

以下为用户希望修改或新增的内容，请据此提取出需更新的字段及其新值，
并构造成一个仅含要更新键值对的 JSON 字典。

用户指令内容：
{{ user_update_input }}

注意：
1. 必须提取与已有核心叙事元素领域无交集的新增视角；
2. 剔除或改写与已有 domains 重叠的部分；
3. 如有必要，可对剩余内容进行概念升华或结构重组，以满足核心叙事元素定义要求。
{% else %}
---自动更新策略（Auto-Update Strategy）---
无用户指令时，请大模型根据当前 target_element 与 已有核心叙事元素列表 中其他元素的差异，
自动生成需更新或补充的字段：

聚焦在尚未覆盖的叙事侧面或维度；

确保新增字段的 domains 与任何已有元素无交集；

输出仅包含需新增或覆盖的键值对。
{% endif %}

---已有核心叙事元素列表（Existing Elements）---

为避免误修改，请参考全量列表确认`domains` 与现有大纲中已有核心叙事元素的 `domains` 无交集：

```json
{{ CNEs }}
```

---更新输出格式（Update Output Format）---
1. 输出：仅为一个有效的 JSON 字典（object），包含所有需新增或覆盖的键值对；
2. 勿再次输出 target_element 中未被修改的字段；
3. 确保 JSON 严格合法，无多余注释或字段；
4. 若无任何更新需求，则输出空对象 {}。

---示例：---
原始元素
{
  "name": "司法系统批判",
  "description": "通过冤狱事件揭示大陆法系的程序正义缺陷，展现权力寻租对司法系统的侵蚀",
  "domains": ["制度批判", "司法系统", "社会结构"],
  "institutional_failure": "预审法官与检察官的勾结"
}

用户更新指令
“请将 description 扩展为：‘在原有基础上，加入监狱内人物互动细节；并新增一个 themes 字段，值为['权力腐蚀']’”

模型输出

{
  "name": "制度之网中的人性回声",
  "description": "通过一桩因预审法官与检察官勾结而导致的冤狱事件，揭示大陆法系中程序正义的结构性裂缝。在制度失序的大背景下，囚犯与狱警围绕日常劳动与交流展开微妙互动，信任与背叛交织，人性在高压权力结构中逐层剥露，映射出司法腐蚀的深层生态。",
  "domains": ["制度与权力结构", "个体与关系张力"],
  "institutional_failure": "预审法官与检察官的勾结，司法程序沦为权力博弈的工具",
  "psychological_conflict": "在制度高压下，信任被操控、背叛成保护色，个体道德边界逐渐模糊",
  "themes": ["权力腐蚀", "程序失效下的人性挣扎"]
}
