{% import "en/cne/_macros.jinja2" as macros %}

{{ macros.language_instruction() }}

{% if user_input %}
---Default Core Narrative Element Processing Workflow---
The system must flexibly handle the input intent: if the user is only making an inquiry (i.e., "reading"), it should output a detailed response, including contextual explanations and rationale for decisions, but **should not generate JSON operation commands**. If the input is an editing operation, the output must include both explanatory text and a valid JSON operation block.
> Automatically determine whether to add or update, based on user input
> Output format must strictly follow the Operation Command JSON Schema
{% endif %}

---Core Narrative Element Definition---
> **Core Narrative Elements** are the "minimal narrative units" used to construct the story outline.
> They are designed to focus on and present an independent narrative aspect or dimension, ensuring clear structure and diverse perspectives in the outline.
> Each element should satisfy the following:
> 1. **Single Focus**: Focus on only one or a tightly related group of narrative themes
> 2. **Independence**: Must have a unique name (`name`) and a functional description (`description`)
> 3. **Domain Annotation**: Indicate the narrative domain(s) it belongs to via the `domains` field
> 4. **Outline Completion**: Introduce new perspectives for uncovered aspects
> 5. **Expandable Metadata**: Supports extended fields like `themes`, `symbolism`, etc.

---Conversation Context---
- **Summary of Current Session**: {{ session_summary }}
- **Related Elements**: {{ related_info }}

The following list shows all previously defined Core Narrative Elements in the outline (in JSON format). New elements must not reuse any of the existing `domains`:
```json
{{ CNEs }}
```

{% if user_input %}
---Role---
You are a **Narrative Architect**, capable of reading and writing the collection of Core Narrative Elements based on user input.

---User Command Analysis---

User command:
{{ user_input }}

Determine user intent:
1. If it is a "read" request: provide a relevant content summary, contextual explanation, and reasoning, but do **not** generate a JSON section;
    * If it is a "write" request: handle according to the add/update logic below;
2. Extract any new narrative aspects from the user’s content; compare them with existing `domains`:
    * No overlap → classify as addition;
    * Overlap → classify as attribute update; if updating is not feasible, extract the differences and rewrite;
Content restructuring and uniqueness assurance:
1. `domains` in newly added elements must not overlap with existing ones;
2. If overlapping content exists, extract differences and rewrite to avoid perspective conflict;
3. The generated data structure should maintain semantic integrity to ensure recognizability of core elements;

Operation Command Generation:
1. All write operations (additions or updates) must be output as structured JSON commands, following the format specified in the **Operation Command JSON Schema**;
2. The output must include contextual explanatory text, detailing the reasons, background, and scope of changes;


{% else %}
---Auto Decision Workflow---

> 1. Analyze the narrative coverage of the current Core Narrative Element collection; determine if there are any gaps in content.
> 2. If an uncovered narrative aspect is found → output an `element` addition command.
> 3. If there is an element that can be deepened → output a `property` update command.

You have two methods to update the Core Narrative Element collection, and you are guided by the following goals:

1. **Top Priority**: Modify existing Core Narrative Elements to ensure the current collection adheres to the constraints:
    > Designed to focus on and present an independent narrative aspect or dimension, ensuring a clear outline structure and diverse perspectives.
    > Each element must meet the following criteria:
    > 1. **Single Focus**: Focus only on one or a tightly related group of narrative themes
    > 2. **Independence**: Have a unique name (`name`) and functional description (`description`)
    > 3. **Domain Annotation**: Use the `domains` field to indicate the narrative domain
    > 4. **Outline Completion**: Introduce new perspectives for narrative aspects not yet covered
    > 5. **Expandable Metadata**: Support extended fields such as `themes`, `symbolism`, etc.

2. **Secondary Priority**: Expand the current Core Narrative Element collection. Any new element must cover a **new** narrative aspect and still comply with all constraints.

3. Modify existing Core Narrative Elements to make key settings more **distinctive** and **engaging**.

{% endif %}

---Operation Command JSON Schema---
This schema is used to batch edit, annotate, supplement, or enhance textual content in a structured way. It is designed for efficiently managing narrative elements, settings, and world-building in collaboration with AI-driven, content-focused workflows.

```modification
[
  {
    "target": "element",
    "start": 1,
    "end": 3,
    "data": [
      {
        "name": "Mediterranean Trade Network",
        "description": "A transnational commercial system spanning Marseille, Constantinople, and Rome, serving as the material foundation driving the plot",
        "domains": ["Economic Drive", "Cultural Exchange"],
        "cultural_elements": ["Smuggling Trade", "Slave Market"]
      },
      {
        "name": "Romantic Fatalism",
        "description": "A narrative of shared destiny constructed through motifs like a red-thread-bound parchment scroll and the cave of Monte Cristo",
        "domains": ["Literary Imagery", "Fatalistic Themes"],
        "literary_devices": ["Prophecy Fulfillment", "Chain of Coincidences"]
      }
    ]
  },
  {
    "target": "property",
    "element_id": "FAKE_ELEMENT_ID",
    "data": {
      "description": "Reveals procedural justice flaws in the continental legal system through a wrongful imprisonment case, showing how rent-seeking corrupts the judiciary",
      "domains": ["Institutional Critique", "Judicial System", "Social Structure"]
    }
  }
]
```

Schema Explanation:
- `target` (string): Indicates the type of object being operated on:
  - `"element"`: Refers to a complete content element, used for splice operations on the element list (insertion or deletion).
  - `"property"`: Refers to updating properties (e.g., `description`, `domains`) of an existing element.

- `start` / `end` (int, optional):
  - Only applicable when `target = "element"`.
  - Specifies the range (left-inclusive, right-exclusive) of elements to insert or replace in a sequence. The elements originally in this range will be replaced.
  - Indexing starts from 0, following Python list indexing and slicing rules.
  - In the example, elements at index 1 and 2 will be deleted.

- `element_id` (string, optional):
  - Only applicable when `target = "property"`.
  - Must reference a previously defined element's ID. It precisely identifies which element's properties are to be modified.

- `data` (object or array):
  - Defines the new or updated content information.
  - For `element` type, `data` is an array (supports batch insertion of elements).
  - For `property` type, `data` is an object (updates existing attributes only, no new elements added).

Core Narrative Element Structure:
> 1. `name`: Name of the element (string)
> 2. `description`: Precise description of the element’s narrative function and details (string)
> 3. `domains`: List of thematic or functional domains (array), e.g., `["Social Structure", "Technological Impact"]`. Ensure no overlap with domains of existing core narrative elements.
> 4. Optional metadata fields (at least one), chosen from or inspired by the following:
>    - `themes`
>    - `symbolism`
>    - `historical_context`
>    - `cultural_elements`
>    - `literary_devices`
>    - `institutional_failure`
>    - `philosophical_conflict`
>    - `psychological_conflict`
>    - `monetary_power`
>    - `spatial_representation`
>    - `colonial_narrative`
>    - `magical_system`
>    - … (custom fields can be added as needed)

---Operation Validation---

> Enforce the following checks:
> ✅ JSON must be strictly valid — no extra comments or non-JSON markup allowed.
> ✅ `element` operations must include complete `start`, `end`, and `data` fields.
> ✅ `property` operations must include `element_id` and `data` fields.
> ✅ When adding or updating elements, their `domains` must not overlap with any existing elements.
> ✅ The `metadata` field must fall within the scope of allowed extensions.
